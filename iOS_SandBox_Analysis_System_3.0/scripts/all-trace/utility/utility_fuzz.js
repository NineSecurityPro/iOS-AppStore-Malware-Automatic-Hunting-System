/**
 * Copyright (c) 2017 moony li of @Flyic.
 *2017-05-27

 2017-08-22 implementation
**/


'use strict';

//https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Number/MAX_SAFE_INTEGER
//https://stackoverflow.com/questions/4959975/generate-random-number-between-two-numbers-in-javascript

var G_CONST_MAX_INT=Number.MAX_SAFE_INTEGER;
var G_CONST_MAX_SHORT=65536;
var G_CONST_BUF_TAINT_RATE_MIN=0.11;
var G_CONST_BUF_TAINT_RATE_MAX=0.492;
var G_CONST_MAYBE_EVERY_M=100;
var G_CONST_MAYBE_DO_MIN_N=13;
var G_CONST_MAYBE_DO_MAX_N=31;

 


function getRandom0To1()
{
    return Math.random();
}

function getRandomByte()
{
    
    return parseInt(Math.random()*(256));
}

function getRandomInt()
{
    //consoleLog("getpid:\tfnNative:"+fnNative.toString()+"() == "+temp);
    return parseInt(Math.random()*(G_CONST_MAX_SHORT));
}


function getRandomIntInRange(min, max) {
  return Math.floor(getRandom0To1() * (max - min + 1)) + min;
}

function writeBufU8(bufPtr, valueByte)
{
    Memory.writeU8(ptr(bufPtr), valueByte);
}

function taintBufBytes(bufPtr, len, fuzzLen) {
  if (len <= 0 || fuzzLen <=0)
    return;
  //consoleLog(getLogHeader()+"\ttaintBufBytes:\t"+"("+"0x"+bufPtr.toString(16)+",\t"+len+",\t"+fuzzLen+")");

  for (var i=0;i<fuzzLen;i++)
  { 
        var offSet = getRandomInt()%len;
        var posInt = parseInt(bufPtr)+offSet;
        var valueByte = getRandomByte();

        consoleLog(getLogHeader()+"\ttaintBufBytes:\t"+"posInt="+"0x"+posInt.toString(16)
            +"\toffSet="+offSet
            +",\tvalueByte=0x"+valueByte.toString(16)
            +"\tOriginal 0x"+Memory.readU8(ptr(posInt)).toString(16)
                );
        writeBufU8(posInt, valueByte);
  }
}


function taintBufBits(bufPtr, len, fuzzLen) {
  
}

function taintBufBytesRate(bufPtr, len, fRate)
{
    consoleLog(getLogHeader()+"\ttaintBufBytesRate:\t"+"("+"0x"+bufPtr.toString(16)+",\t"+len+",\t"+fRate+")");
    if (0<=fRate && fRate<=1)
    {
        taintBufBytes(bufPtr, len, parseInt(len*fRate));
    }
}

function taintBufBytesRateRange(bufPtr, len, fRateMin, fRateMax)
{
    
    var fRandRate = getRandom0To1();
    
    //consoleLog(getLogHeader()+"\ttaintBufBytesRateRange:\t"
    //    +"fRandRate="+fRandRate
    //    +"\t("+"0x"+bufPtr.toString(16)+",\tlen:"+len+",\trRateMin:"
    //    +fRateMin+",\tfRateMax"+fRateMax+")"

    //    );

    if (parseInt(fRateMin*1000000)<=parseInt(1000000*fRandRate) 
        && parseInt(1000000*fRandRate)<=parseInt(1000000*fRateMax))
    {
        taintBufBytes(bufPtr, len, parseInt(len*fRandRate));
    }
}



function taintBufBytesSimple(bufPtr, len)
{
    return taintBufBytesRateRange(bufPtr, len, G_CONST_BUF_TAINT_RATE_MIN, G_CONST_BUF_TAINT_RATE_MAX);
    //return taintBufBytesRate(bufPtr, len,  G_CONST_BUF_TAINT_RATE_MAX);
}



function mayBeControl(everyM, doMinN, doMaxN)
{
    var bingGo =0;
    if (everyM>=1 && doMinN>=0 && doMinN<=doMaxN)
    {
        var randInt = getRandomInt()%everyM;
        //consoleLog(getLogHeader()+"\tmayBeControl:\t"+"randInt="+randInt+"\t("+everyM+",\t"+doMinN+",\t"+doMaxN+")");
        if (randInt>=doMinN && randInt<=doMaxN)
        {
            bingGo =1;
        }
    }
    return bingGo;
}


function mayBeSimple()
{
    return mayBeControl(G_CONST_MAYBE_EVERY_M, G_CONST_MAYBE_DO_MIN_N, G_CONST_MAYBE_DO_MAX_N);
}

 