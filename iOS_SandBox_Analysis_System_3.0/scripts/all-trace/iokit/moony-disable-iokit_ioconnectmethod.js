/**
 * Copyright (c) 2017 moony li of @Flyic.
 *2017-05-27

**/


'use strict';



(function() {

var connection = '';
var selector = -1;
var input;
var inputCnt;
var inputStruct;
var inputStructCnt;

var txnType="moony?";
var moduleName="IOKit";
//var methodName="IOConnectCallScalarMethod";
var methodName="IOConnectCallMethod";
var servicename = ''
var resolver = new ApiResolver('module');
var a_method = {};

//resolver.enumerateMatches('exports:libxpc.dylib!_xpc_connection_create', {
resolver.enumerateMatches('exports:'+moduleName+"!"+methodName, {
    onMatch: function(match) {
        a_method.name = match.name;
        a_method.address = match.address;

        var data = {};
        var send_data = {};
        send_data.time = new Date();
        send_data.txnType = txnType;
        send_data.lib = moduleName;
        send_data.method = methodName;
        send_data.artifact = [];

        data.name = match.name;
        data.value = match.address;
        data.argSeq = -1;
        send_data.artifact.push(data);

        send(JSON.stringify(send_data));
    },
    onComplete: function() {}
});


if (a_method.address)
{
    consoleLog("Interceptor.attach("+a_method.name+":"+a_method.address+")");
    Interceptor.attach(a_method.address,
    {
        onEnter: function(args)
        {
            //servicename = iokit_get_class_by_connection(args[0]);
            connection = args[0];
            selector = args[1];
            input = args[2];
            inputCnt = args[3];
            inputStruct = args[4];
            inputStructCnt = args[5];
        },//end of on Enter

        onLeave: function(retval) {
            var connectionName="";
            var send_data = {};
            send_data.time = new Date();
            send_data.txnType = txnType;
            send_data.lib = moduleName;
            send_data.method = methodName;
            send_data.artifact = [];
            //this.context.pc = 0xfff00;
            //this.context.sp = 0x00000;


            var text = getLogHeader()+moduleName+"!"+methodName+"\t";
            text = text + "\r\nconnection="+connection+",\tselector="+selector;
            text = text + "\r\ninput="+input+",\tinputCnt="+inputCnt;
            consoleLog(text);

            if (inputCnt>0)
            {
                console.log(hexdump(input, {
                                          offset: 0,
                                          length: inputCnt*16,
                                          header: true,
                                          ansi: true
                                        }));
            }
            text = "\r\ninputStruct="+inputStruct+",\tinputStructCnt="+inputStructCnt;
            consoleLog(text);
            if (inputStructCnt>0)
            {
              var len = inputStructCnt;
              if (len>0xf)
              {
                len = 0xf;
              }
            console.log(hexdump(inputStruct, {
                                          offset: 0,
                                          length: len,
                                          header: true,
                                          ansi: true
                                        }));
             }


            var data = {};
            data.name = "connection";
            data.value = connection;
            data.argSeq = 0;
            send_data.artifact.push(data);

            var data = {};
            data.name = "selector";
            data.value = selector;
            data.argSeq = 1;
            send_data.artifact.push(data);

            var backtrace = Thread.backtrace(this.context, Backtracer.FUZZY).map(DebugSymbol.fromAddress);
            var formatBt = backtrace.toString().replace(new RegExp(",0x","gm"),",\t\n0x");
            consoleLog(getLogHeader()+moduleName+"!"+methodName+"\t"+"call stack:\r\n\r\n"+backtrace.toString().replace(new RegExp(",0x","gm"),",\t\n0x"));

            var data = {};
            data.name = "formatBt";
            data.value = formatBt;
            data.argSeq = -1;
            send_data.artifact.push(data);

            send(JSON.stringify(send_data));
    }//end of Leave
  });//end of attach

}
else
{
   var data = "resolver.enumerateMatches "+'exports:'+moduleName+"!"+methodName;
   consoleLog(data+" failed!");
}
})();





