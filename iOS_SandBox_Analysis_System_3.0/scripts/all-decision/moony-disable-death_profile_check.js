/**
 * Copyright (c) 2017 moony li of @Flyic.
 *2017-05-27

 2017-09-19 implementation
**/



'use strict';


(function () {

var death_profile_check_profile = require("./death_profile_check_profile.js");
var pd = require('pretty-data').pd;
var traverse = require('traverse');
var chalk = require('chalk');


exports.deathProfileCheck = function(jsonObj) 
{
	var evidenceInBrief = {};
	var retInfo={};
	//console.log(jsonObj);
	var jsonStr = JSON.stringify(jsonObj);
	if ( 1
  		//&& -1 == jsonStr.search("<key>SignerCerts</key>")
  		//No signed signature
		&&-1 < jsonObj.method.search(/read|write/)
		&& -1 < jsonObj.lib.search("libsystem_kernel.dylib")
		&& jsonObj.artifact.length >= 3
		//For iOS 9.0.x
		//&& -1 < jsonObj.artifact[0].value.search(/^\/private\/var\/mobile\/Library\/ConfigurationProfiles.*profile-.*stub$/)
		//For iOS 10.1.1
		///private/var/containers/Shared/SystemGroup/systemgroup.com.apple.configurationprofiles/Library/ConfigurationProfiles/profile-4ecba0b5def636872b1da380625035b4adfb4c5f4f38788cf1774579fe90dd3c.stub
		&& -1 < jsonObj.artifact[0].value.search(/.*ConfigurationProfiles\/profile-.*stub$/)
		&& -1 < jsonObj.artifact[5].name.search("backtrace")
		//For iOS 9.0.x and 10.1.1
		&& -1 < jsonObj.artifact[5].value.search(/(installedProfileDataWithIdentifier|installedProfileWithIdentifier)/)
		)
	{
		
		
		//console.log(jsonObj);
		//Check read buffer
		var hexifiedBuf = jsonObj.artifact[2].value;
		var xml_parser = require('./utility_xml_parser.js');
		var codec = require('./utility_codec.js');
		var buf = codec.unhexify(hexifiedBuf);
		//console.log("unhexify:"+codec.unhexify('377abcaf271c'));
		//console.log("unhexify begin:"+buf+":unhexify end!");
		var plistObj = xml_parser.parseXML(buf);
		//console.log(plistObj);
		if (plistObj.hasOwnProperty("SignerCerts"))
		{
			//With signed certicification
		}
		else
		{
			//Without
			retInfo = death_profile_check_profile.deathProfileCheckProfileByObjJson(plistObj);
			retInfo.profilePath=jsonObj.artifact[0].value;
			//console.log(retInfo);
			/*
			//raw log evidence if need
			var data = {};
	        data.name = "raw_log";
	        data.value = jsonObj;
			retInfo.evidences.push(data);
			*/
	
		}

		
	
	}

	return retInfo;
    //parseXML(buf);

//var buf;
//var hexifiedBuf="3c3f786d6c2076657273696f6e3d22312e302220656e636f64696e673d225554462d38223f3e0a3c21444f435459504520706c697374205055424c494320222d2f2f4170706c652f2f44544420504c49535420312e302f2f454e222022687474ST703a2f2f7777772e6170706c652e636f6d2f445444732f50726f70657274794c6973742d312e302e647464223e0a3c706c6973742076657273696f6e3d22312e30223e0a3c646963743e0a093c6b65793e496e7374616c6c446174653c2f6b65793e0a093c646174653e323031372d30392d31385431313a34353a32355a3c2f646174653e0a093c6b65793e496e7374616c6c4f7074696f6e733c2f6b65793e0a093c646963743e0a09093c6b65793e66696c746572466c61673c2f6b65793e0a09093c696e74656765723e313c2f696e74656765723e0a093c2f646963743e0a093c6b65793e4d4350726f66696c65497352656d6f76616c537475623c2f6b65793e0a093c747275652f3e0a093c6b65793e5061796c6f6164436f6e74656e743c2f6b65793e0a093c61727261793e0a09093c646963743e0a0909093c6b65793e46756c6c53637265656e3c2f6b65793e0a0909093c747275652f3e0a0909093c6b65793e497352656d6f7661626c653c2f6b65793e0a0909093c66616c73652f3e0a0909093c6b65793e4c6162656c3c2f6b65793e0a0909093c737472696e673e594a534e50493c2f737472696e673e0a0909093c6b65793e5061796c6f61644465736372697074696f6e3c2f6b65793e0a0909093c737472696e673e594a534e504956697275733c2f737472696e673e0a0909093c6b65793e5061796c6f6164446973706c61794e616d653c2f6b65793e0a0909093c737472696e673e594a534e50493c2f737472696e673e0a0909093c6b65793e5061796c6f61644964656e7469666965723c2f6b65793e0a0909093c737472696e673e636f6d2e796a736e70692e76697275733c2f737472696e673e0a0909093c6b65793e5061796c6f61644f7267616e697a6174696f6e3c2f6b65793e0a0909093c737472696e673e594a534e50493c2f737472696e673e0a0909093c6b65793e5061796c6f6164547970653c2f6b65793e0a0909093c737472696e673e636f6d2e6170706c652e776562436c69702e6d616e616765643c2f737472696e673e0a0909093c6b65793e5061796c6f6164555549443c2f6b65793e0a0909093c737472696e673e46324645463146412d454644312d344642452d393343442d3244383831433246463542323c2f737472696e673e0a0909093c6b65793e5061796c6f616456657273696f6e3c2f6b65793e0a0909093c696e74656765723e313c2f696e74656765723e0a0909093c6b65793e53617665644964656e7469666965723c2f6b65793e0a0909093c737472696e673e41393437374137463630414234334534383032373138314231423843423945323c2f737472696e673e0a0909093c6b65793e55524c3c2f6b65793e0a0909093c737472696e673e687474703a2f2f6c697665646f6f722e626c6f67696d672e6a702f6d696e6573746172303131302f696d67732f662f392f66393237336234332d732e6a70673c2f737472696e673e0a09093c2f646963743e0a09093c646963743e0a0909093c6b65793e46756c6c53637265656e3c2f6b65793e0a0909093c747275652f3e0a0909093c6b65793e497352656d6f7661626c653c2f6b65793e0a0909093c66616c73652f3e0a0909093c6b65793e4c6162656c3c2f6b65793e0a0909093c737472696e673e594a534e50493c2f737472696e673e0a0909093c6b65793e5061796c6f61644465736372697074696f6e3c2f6b65793e0a0909093c737472696e673e594a534e504956697275733c2f737472696e673e0a0909093c6b65793e5061796c6f6164446973706c61794e616d653c2f6b65793e0a0909093c737472696e673e594a534e50493c2f737472696e673e0a0909093c6b65793e5061796c6f61644964656e7469666965723c2f6b65793e0a0909093c737472696e673e636f6d2e796a736e70692e76697275733c2f737472696e673e0a0909093c6b65793e5061796c6f61644f7267616e697a6174696f6e3c2f6b65793e0a0909093c737472696e673e594a534e50493c2f737472696e673e0a0909093c6b65793e5061796c6f6164547970653c2f6b65793e0a0909093c737472696e673e636f6d2e6170706c652e776562436c69702e6d616e616765643c2f737472696e673e0a0909093c6b65793e5061796c6f6164555549443c2f6b65793e0a0909093c737472696e673e34444644393132352d414130322d343433432d394542332d4346383031453536363237453c2f737472696e673e0a0909093c6b65793e5061796c6f616456657273696f6e3c2f6b65793e0a0909093c696e74656765723e313c2f696e74656765723e0a0909093c6b65793e53617665644964656e7469666965723c2f6b65793e0a0909093c737472696e673e42463641393846303037304334443339413745314632383334343834374537333c2f737472696e673e0a0909093c6b65793e55524c3c2f6b65793e0a0909093c737472696e673e687474703a2f2f6c697665646f6f722e626c6f67696d672e6a702f6d696e6573746172303131302f696d67732f662f392f66393237336234332d732e6a70673c2f737472696e673e0a09093c2f646963743e0a09093c646963743e0a0909093c6b65793e46756c6c53637265656e3c2f6b65793e0a0909093c747275652f3e0a0909093c6b65793e497352656d6f7661626c653c2f6b65793e0a0909093c66616c73652f3e0a0909093c6b65793e4c6162656c3c2f6b65793e0a0909093c737472696e673e594a534e50493c2f737472696e673e0a0909093c6b65793e5061796c6f61644465736372697074696f6e3c2f6b65793e0a0909093c737472696e673e594a534e504956697275733c2f737472696e673e0a0909093c6b65793e5061796c6f6164446973706c61794e616d653c2f6b65793e0a0909093c737472696e673e594a534e50493c2f737472696e673e0a0909093c6b65793e5061796c6f61644964656e7469666965723c2f6b65793e0a0909093c737472696e673e636f6d2e796a736e70692e76697275733c2f737472696e673e0a0909093c6b65793e5061796c6f61644f7267616e697a6174696f6e3c2f6b65793e0a0909093c737472696e673e594a534e50493c2f737472696e673e0a0909093c6b65793e5061796c6f6164547970653c2f6b65793e0a0909093c737472696e673e636f6d2e6170706c652e776562436c69702e6d616e616765643c2f737472696e673e0a0909093c6b65793e5061796c6f6164555549443c2f6b65793e0a0909093c737472696e673e33346533633839362d613564622d346162332d383033362d3531346532396430333633363c2f737472696e673e0a0909093c6b65793e5061796c6f616456657273696f6e3c2f6b65793e0a0909093c696e74656765723e313c2f696e74656765723e0a0909093c6b65793e53617665644964656e7469666965723c2f6b65793e0a0909093c737472696e673e33453137313939353935373934314246384635394536413938464335324142313c2f737472696e673e0a0909093c6b65793e55524c3c2f6b65793e0a0909093c737472696e673e687474703a2f2f6c697665646f6f722e626c6f67696d672e6a702f6d696e6573746172303131302f696d67732f662f392f66393237336234332d732e6a70673c2f737472696e673e0a09093c2f646963743e0a093c2f61727261793e0a093c6b65793e5061796c6f61644465736372697074696f6e3c2f6b65793e0a093c737472696e673e4a61696c627265616b20666f7220694f53392e332e342d694f5331302e302e323c2f737472696e673e0a093c6b65793e5061796c6f6164446973706c61794e616d653c2f6b65793e0a093c737472696e673e6958696e7470776e2d2568756761253c2f737472696e673e0a093c6b65793e5061796c6f61644964656e7469666965723c2f6b65793e0a093c737472696e673e636f6d2e796a736e70692e76697231356378746a636475732e3c2f737472696e673e0a093c6b65793e5061796c6f61644f7267616e697a6174696f6e3c2f6b65793e0a093c737472696e673e6958696e74205465616d3c2f737472696e673ent0a093c6b65793e5061796c6f6164547970653c2f6b65793e0a093c737472696e673e436f6e66696775726174696f6e3c2f737472696e673e0a093c6b65793e5061796c6f6164555549443c2f6b65793e0a093c737472696e673e43433833324238422d323345452d343236312d423944322d3436444644453130383036453c2f737472696e673e0a093c6b65793e5061796c6f616456657273696f6e3c2f6b65793e0a093c696e74656765723e313c2f696e74656765723e0a093c6b65793e50726f647563744275696c6456657273696f6e3c2f6b65793e0a093c737472696e673e3133413435323c2f737472696e673e0a093c6b65793e50726f6475637456657273696f6e3c2f6b65793e0a093c737472696e673e392e302e323c2f737472696e673e0a093c6b65793e50726f66696c65576173456e637279707465643c2f6b65793e0a093c66616c73652f3e0a093c6b65793e50726f66696c655761734c6f636b65643c2f6b65793e0a093c747275652f3e0a3c2f646963743e0a3c2f706c6973743e0a";
//var xml_parser = require('./utility_xml_parser.js');
//var codec = require('./utility_codec.js');
//buf = codec.unhexify(hexifiedBuf);
//console.log("unhexify:"+codec.unhexify('377abcaf271c'));
//console.log("unhexify:"+buf);
//xml_parser.parseXML(buf);

};




})();


